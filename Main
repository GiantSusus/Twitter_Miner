-module(main).
-export([scheduler/0, start_link_handler/0, start/0, start_link_scheduler/0, stop/1, init/0, loop/0]).

%% erl -pa /home/erlach/riak-erlang-client/ebin/ /home/erlach/riak-erlang-client/deps/*/ebin

%% -----------------------------------------------------------------------
%% Main
%% -----------------------------------------------------------------------
%% Run with main:go(), will run at 2 given times each day.
%% Will start scheduler, handler module and the supervisor_loop.
%% Stop function will exit the given process name(registered name).
%% -----------------------------------------------------------------------

%% Start
start() -> 
    application:ensure_all_started(twitterminer),
    start_link_scheduler(),
    start_link_handler(),
    init().

%% Schedule
scheduler() ->
    {{_,_,_},{H, M, _}} = calendar:local_time(),
    receive
        after 10000 ->
            ok
    end,
    case {H, M} of 
        {12, 44} -> 
            twitterminer_riak:twitter_example(), 
            starter ! {self(), start}, 
            scheduler();
        {12, 48} -> 
            twitterminer_riak:twitter_example(), 
            starter ! {self(), start}, 
            scheduler();
        {H, M} -> scheduler()
    end.

%% Handler
start_link_handler() ->
    case whereis(starter) of
        undefined ->
            process_flag(trap_exit, true),
            register(starter, Pid = spawn_link(handler, loop, [])),
            {ok, Pid};
        Pid -> 
            {ok, Pid}
    end.

%% Scheduler
start_link_scheduler() ->
    case whereis(scheduler) of
        undefined ->
            process_flag(trap_exit, true),
            register(scheduler, Pid = spawn_link(?MODULE, scheduler, [])),
            {ok, Pid};
        Pid -> 
            {ok, Pid}
    end.

%% Stop 
stop(Name) -> 
    exit(whereis(Name), stop).

%% Init
init() ->
    Pid=spawn_link(?MODULE, loop, []),
    register(supervisor_loop, Pid).

%% Loop 
loop() ->
    case whereis(supervisor_loop) of
        undefined -> error;
        Pid ->
           receive
                {Pid, start, Msg} -> 
                    io:format("~p~n", [Msg]),
                    starter ! {self(), start},
                    loop();
                {Pid, stop} -> 
                    Pid ! {self(), stop, stopped},
                    loop();
                {'EXIT', Pid, _} -> 
                    start(),
                    loop();
                {Pid, restart_handler} ->
                    start_link_handler(),
                    loop();
                {Pid, restart_scheduler} ->
                    start_link_scheduler(),
                    loop()
            end
    end.
